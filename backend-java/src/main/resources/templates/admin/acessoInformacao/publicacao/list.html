<section class="section-acoes">
    <a href="./admin">
        <button class="btn btn-success btn-flutuante mb-2" >
            <i class="fa fa-arrow-left"></i>
        </button>
    </a>
    <button class="btn btn-success btn-flutuante mb-2" 
        onclick="admin.addTab({id: 'nova-publicacao', title: 'Nova Publicação', url: '/admin/publicacoes/form'})"
    >
        <i class="fa fa-plus"></i>
    </button>
    <button class="btn btn-success btn-flutuante mb-2" id="btn-toggle-barra">
        <i class="fa fa-search"></i>
    </button> 
</section>

<section class="section-barra-pesquisa-desktop oculto" id="section-barra-pesquisa-desktop">
    <div class="row barra-pesquisa-desktop" id="barra-pesquisa-desktop">     
        <div class="col-md-12">
            <div class="card">
                <div class="card-header" ><span class="text-muted">Pesquisa Por...</span></div>
                <div class="card-body">
                    <form id="search">
                        <div class="row">
                            <div class="col-md-12">
                                <div class="input-group  input-group-sm mb-3">
                                    <div class="input-group-prepend">
                                        <span class="input-group-text" id="inputGroupPrepend1"> <i class="fa fa-file-text"> </i></span>
                                    </div>
                                    <input type="text" name="c1"  id="c1" class="form-control" placeholder="Código">
                                </div>
                            </div>
                            <div class="col-md-12">
                                <div class="input-group  input-group-sm mb-3">
                                    <div class="input-group-prepend">
                                        <span class="input-group-text" id="inputGroupPrepend1"> <i class="fa fa-file-text"> </i></span>
                                    </div>
                                    <input type="text" name="c2"  id="c2" class="form-control" placeholder="Nome">
                                </div>
                            </div>
                            <div class="col-md-12">
                                <div class="input-group  input-group-sm mb-3">
                                    <input type="date" name="c3"  id="c3" class="form-control" placeholder="CPF">
                                </div>
                            </div>
                            <div class="col-md-12">
                                <div class="input-group  input-group-sm mb-3">
                                    <input type="date" name="c4"  id="c4" class="form-control" placeholder="CPF">
                                </div>
                            </div>
                        </div>      
                    </form>
                </div>
                <div class="modal-footer p-2 border-top-0">
                    <button type="button" class="btn btn-secondary btn-sm" id="btn-pesquisar" onclick="listar()" >
                        <i class="fa fa-search"></i> Pesquisar
                    </button>
                </div>
            </div>
        </div>
    </div>
</section>

<section>
    <div class="view-index-table-container">
        <table class="table-sm  w-100">
            <thead id="thead">
            </thead>
            <tbody id="tbody">
            </tbody>
        </table>
        <div class="text-center">
            <span class="pt-5" id="tab_1_alerts"></span>
            <img class="loading mt-5" src="../img/loading-sm.svg" style="display: none">
        </div>  
    </div>
    <div class="d-flex justify-content-end w-100 align-items-center border bg-white">
        <i class="btn fa fa-chevron-circle-left" style="font-size: 20px;" id="anterior" disabled></i>
        <span id="numeracao" class="size-14"></span>
        <i class="btn fa fa-chevron-circle-right" style="font-size: 20px" id="proximo" disabled></i>
    </div>
</section>

<style>
    .oculto {
        transform: translateX(100%);
        transition: transform 0.3s ease-in-out;
        position: absolute;
        
        right: 0;
        top: 10vh;
        z-index: 1050;
        overflow-y: auto;
        overflow-x: hidden;

        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
    }

    .visivel {
      transform: translateX(0);
    }

    .section-acoes{
      position: fixed;
      top: 15.5vh;
      right: 15px;
      transform: translateY(-50%);
      z-index: 1100;
    }

    .btn-flutuante {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background-color: #28a745;
      color: white;
      border: none;
      cursor: pointer;

      display: flex;
      align-items: center;
      justify-content: center;

      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
      transition: background-color 0.2s ease;
    }

    .btn-flutuante:hover {
      background-color: #218838;
    }
</style>
<script>
  document.getElementById('btn-toggle-barra').addEventListener('click', () => {
    const barra = document.getElementById('section-barra-pesquisa-desktop');
    barra.classList.toggle('visivel');
  });

  document.getElementById('btn-pesquisar').addEventListener('click', () => {
    const barra = document.getElementById('section-barra-pesquisa-desktop');
    barra.classList.toggle('visivel');
  });

</script>
<script>
    function listar() {
        $("tr").remove();
        $.ajax({
            url: 'http://localhost:8080/admin/publicacoes/listar',
            cache: false,
            type: 'GET',
            data: $('#search').serialize(),
            dataType: "json",
            beforeSend: function () {
                $(".loading").show();
            },
            error: function () {
                $(".loading").hide();
                $("#tab_1_alerts").html("Não foi possivel executar a ação desejada, favor entrar em contato com o administrador.");
            },
            success: function (retorno) {
                $(".loading").hide();
                if(retorno.length === 0){
                    $("#tab_1_alerts").show()
                    $("#tab_1_alerts").html("Não há dados cadastrados.")
                    return
                }
                var tamanhoPagina = 10;
                var pagina = 0;
                function paginar() {
                    for (var i = pagina * tamanhoPagina; i < retorno.length && i < (pagina + 1) * tamanhoPagina; i++) {
                        $("#tbody")
                        .append(
                            $('<tr id="linha' + retorno[i].id + '">')
                            .append($('<td class="px-0 pb-2">').append(`
                                <div class="px-3 py-2 border" style="border-radius: 5px; border-left: 4px solid rgba(33,136,60)!important;  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);">
                                    <div style="height: 50px; overflow-y:hidden">
                                        <small><b>Cód./Desc: </b>${retorno[i].id} - ${retorno[i].descricao || '-'}</small><br/>
                                    </div>
                                    <div class="d-flex justify-content-between">
                                        <div>
                                            <small><b>Tipo: </b>${retorno[i].tipo}</small>&emsp;
                                            <small><b>Exerc.: </b>${retorno[i].exercicio}</small>&emsp;
                                            <small><b>Data: </b>${retorno[i].data_publicacao || '-'}</small>&emsp;
                                        </div>
                                        <div>
                                            <a style="text-decoration: none; color: gray" href="javascript::void" onclick="listarArquivos(' + retorno[i].id + ', \'publicacoes\',\'tbody_arquivos_modal\')"data-toggle="modal" data-target="#modal-files">
                                                <i class="fa fa-paperclip text-muted"></i>
                                            </a>
                                            &nbsp;
                                            <a style="text-decoration: none; color: gray" href="javascript::void" onclick="admin.navigate({url:'/admin/publicacoes/form', containerId:'main', id: ${retorno[i].id}})" >
                                                <i class="fa fa-cog text-muted"></i>
                                            </a>
                                            &nbsp;
                                            <a style="text-decoration: none; color: gray" href="javascript::void" onclick="deletar(' + retorno[i].id + ', 1)">
                                                <i class="fa fa-trash text-muted"></i>
                                            </a>
                                            &nbsp;
                                        </div>
                                    </div>
                                </div>
                            `))
                        );
                    }
                    $("#echos").empty();
                    $('#numeracao').text('Página ' + (pagina + 1) + ' de ' + Math.ceil(retorno.length / tamanhoPagina));
                }
                function ajustarBotoes() {
                    $('#proximo').prop('disabled', retorno.length <= tamanhoPagina || pagina >= Math.ceil(retorno.length / tamanhoPagina) - 1);
                    $('#anterior').prop('disabled', retorno.length <= tamanhoPagina || pagina == 0);
                }
                $(function () {
                    $('#proximo').click(function () {
                        if (pagina < retorno.length / tamanhoPagina - 1) {
                            $("tr").remove();
                            pagina++;
                            paginar();
                            ajustarBotoes();
                        }
                    });
                    $('#anterior').click(function () {
                        if (pagina >= 1) {
                            $("tr").remove();
                            pagina--;
                            paginar();
                            ajustarBotoes();
                        }
                    });
                    paginar();
                    ajustarBotoes();
                });
            }
        });
    }

    function  update(id) {
        $.ajax({
            url: '../../_php/Dispatch.php?controller=ControllerPublicacoes&&action=update&&id=' + id,
            type: 'POST',
            data: $('#tab-1-form-1').serialize(),
            beforeSend: function () {
                toastr["info"]("Aguarde, estamos providenciando o envio de suas informações!")
            },
            success: function (data) {
                $('.toast-info').hide();
                if (isNaN(data)) {
                    toastr["error"](data);
                } else {
                    switch (data) {
                        case '1':
                            toastr["success"]("Dados atualizados com sucesso!");
                            break;
                        case '0':
                            toastr["success"]("Embora a transação tenha sido efetuada com sucesso você não inseriu nenhum dado novo!");
                            break;
                    }
                }
            }
        });
    }
    
    function deletar(id) {
        if (confirm("TEM CERTEZA QUE DESEJA EXCLUIR ESSE REGISTRO?")) {
            $.ajax({
                url: '../../_php/Dispatch.php?controller=ControllerPublicacoes&&action=delete',
                type: "POST",
                data: {id: id},
                success: function (data) {
                    $("#linha" + id).remove();
                    toastr["success"]("Excluido com sucesso!");
                }
            });
        };
    }


    function importarJson() {
      var formData = new FormData(document.getElementById('formJson'));
      $.ajax({
        url: '/admin/publicacoes/api',
        type: 'POST',
        data: formData,
        contentType: false,
        processData: false,
        beforeSend: function () {
          $(".loadingFormJson").show();
          toastr["info"]("Aguarde, as informções estão sendo salvas no banco de dados!");
        },
        error: function(error) {
          console.error(error);
          $(".loadingFormJson").hide();
        },
        success: function(response) {
          $(".loadingFormJson").hide();
          console.log(response);
          toastr["success"]("Cadastro realizado com sucesso!");
        },
      });
    }

    listar();
</script>